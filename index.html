import asyncio
import json
import gspread
import aiohttp
from oauth2client.service_account import ServiceAccountCredentials
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import CommandStart
from aiogram.types import WebAppInfo, ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardRemove
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from datetime import datetime
from aiocryptopay import AioCryptoPay, Networks

# --- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ---
API_TOKEN = '8388354020:AAGHte3KqdmQIBUQeUpsGbfAlvH7ztoydGQ'
CRYPTO_PAY_TOKEN = '523352:AAiKf0sVP7iiTkcqKLx5exxPQjHod8wmYJg'
ADMIN_ID = 8303020897 
SHOP_URL = "https://boss00111.github.io/my-furniture-shop/"
SHEET_NAME = "Comfort and Furniture" 
BASE_PREPAYMENT = 200 

crypto = AioCryptoPay(token=CRYPTO_PAY_TOKEN, network=Networks.MAIN_NET)

# –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –≤ Google –¢–∞–±–ª–∏—Ü—è—Ö
try:
    scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
    creds = ServiceAccountCredentials.from_json_keyfile_name("creds.json", scope)
    client = gspread.authorize(creds)
    sheet = client.open(SHEET_NAME).get_worksheet(0) # –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –ø–µ—Ä—à–∏–π –ª–∏—Å—Ç
    print("‚úÖ –¢–∞–±–ª–∏—Ü—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–∞ —É—Å–ø—ñ—à–Ω–æ!")
except Exception as e: 
    print(f"‚ùå Sheets Error: {e}")

bot = Bot(token=API_TOKEN)
dp = Dispatcher()

class OrderSteps(StatesGroup):
    waiting_for_name, waiting_for_phone, waiting_for_operator, waiting_for_address, waiting_for_comment, waiting_for_prepay_type, waiting_for_support_msg = State(), State(), State(), State(), State(), State(), State()

async def get_usdt_uah_rate():
    try:
        async with aiohttp.ClientSession() as session:
            async with session.get("https://api.binance.com/api/v3/ticker/price?symbol=USDTUAH") as resp:
                data = await resp.json()
                return float(data['price'])
    except: return 43.50 

def get_main_keyboard():
    return ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="üõç –í—ñ–¥–∫—Ä–∏—Ç–∏ –∫–∞—Ç–∞–ª–æ–≥", web_app=WebAppInfo(url=SHOP_URL))],[KeyboardButton(text="üí¨ –ù–∞–ø–∏—Å–∞—Ç–∏ –º–µ–Ω–µ–¥–∂–µ—Ä—É")],[KeyboardButton(text="üîÑ –†–µ—Å—Ç–∞—Ä—Ç –±–æ—Ç–∞")]], resize_keyboard=True)

@dp.message(F.text == "üîÑ –†–µ—Å—Ç–∞—Ä—Ç –±–æ—Ç–∞")
@dp.message(CommandStart())
async def start(message: types.Message, state: FSMContext):
    await state.clear()
    await message.answer("üè† –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é Comfort and Furniture:", reply_markup=get_main_keyboard())

@dp.message(F.web_app_data)
async def handle_catalog_data(message: types.Message, state: FSMContext):
    data = json.loads(message.web_app_data.data)
    items = data.get("items", "")
    total_price = data.get("totalPrice", 0)
    total_qty = int(data.get("totalQty", 1)) 
    prepay = total_qty * BASE_PREPAYMENT
    
    await state.update_data(item_name=items, total_price=total_price, calculated_prepay=prepay, total_qty=total_qty)
    
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üíé –ü–æ–≤–Ω–∞ –æ–ø–ª–∞—Ç–∞ –ö—Ä–∏–ø—Ç–æ—é", callback_data="pay_crypto_full")],
        [InlineKeyboardButton(text=f"üì¶ –ù–∞–ª–æ–∂–∫–∞ (–∞–≤–∞–Ω—Å {prepay} –≥—Ä–Ω)", callback_data="pay_cash")]
    ])
    
    await message.answer(
        f"üõí <b>–í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:</b>\n{items}\n\n"
        f"üî¢ –ö—ñ–ª—å–∫—ñ—Å—Ç—å: <b>{total_qty} —à—Ç.</b>\n"
        f"üí∞ –°—É–º–∞: <b>{total_price} –≥—Ä–Ω</b>", 
        reply_markup=kb, parse_mode="HTML"
    )

@dp.callback_query(F.data.in_(["pay_cash", "pay_crypto_full"]))
async def process_payment(callback: types.CallbackQuery, state: FSMContext):
    await state.update_data(pay_method="cash" if callback.data == "pay_cash" else "crypto_full")
    await callback.message.answer("–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ –ü—Ä—ñ–∑–≤–∏—â–µ —Ç–∞ –Ü–º'—è:", reply_markup=ReplyKeyboardRemove())
    await state.set_state(OrderSteps.waiting_for_name)
    await callback.answer()

@dp.message(OrderSteps.waiting_for_name)
async def name_step(message: types.Message, state: FSMContext):
    await state.update_data(customer_name=message.text)
    await message.answer("–í–≤–µ–¥—ñ—Ç—å –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É:")
    await state.set_state(OrderSteps.waiting_for_phone)

@dp.message(OrderSteps.waiting_for_phone)
async def phone_step(message: types.Message, state: FSMContext):
    await state.update_data(customer_phone=message.text)
    kb = InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text="üî¥ –ù–æ–≤–∞ –ü–æ—à—Ç–∞", callback_data="op_nova")],[InlineKeyboardButton(text="üü° –£–∫—Ä–ø–æ—à—Ç–∞", callback_data="op_ukr")]])
    await message.answer("–û–±–µ—Ä—ñ—Ç—å —Å–ª—É–∂–±—É –¥–æ—Å—Ç–∞–≤–∫–∏:", reply_markup=kb)
    await state.set_state(OrderSteps.waiting_for_operator)

@dp.callback_query(F.data.startswith("op_"))
async def operator_step(callback: types.CallbackQuery, state: FSMContext):
    op = "–ù–æ–≤–∞ –ü–æ—à—Ç–∞" if callback.data == "op_nova" else "–£–∫—Ä–ø–æ—à—Ç–∞"
    await state.update_data(operator=op)
    msg = "–î–ª—è <b>–£–∫—Ä–ø–æ—à—Ç–∏</b> –≤–≤–µ–¥—ñ—Ç—å –ø–æ–≤–Ω—É –∞–¥—Ä–µ—Å—É —Ç–∞ <b>–Ü–ù–î–ï–ö–°</b>:" if callback.data == "op_ukr" else "–î–ª—è <b>–ù–æ–≤–æ—ó –ü–æ—à—Ç–∏</b> –≤–≤–µ–¥—ñ—Ç—å –ú—ñ—Å—Ç–æ —Ç–∞ –ù–æ–º–µ—Ä –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è:"
    await callback.message.answer(msg, parse_mode="HTML")
    await state.set_state(OrderSteps.waiting_for_address)
    await callback.answer()

@dp.message(OrderSteps.waiting_for_address)
async def address_step(message: types.Message, state: FSMContext):
    await state.update_data(address=message.text)
    await message.answer("–ö–æ–º–µ–Ω—Ç–∞—Ä –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (–∞–±–æ '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏'):", reply_markup=ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ ‚è≠")]], resize_keyboard=True))
    await state.set_state(OrderSteps.waiting_for_comment)

@dp.message(OrderSteps.waiting_for_comment)
async def comment_step(message: types.Message, state: FSMContext):
    await state.update_data(comment=message.text if message.text != "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ ‚è≠" else "–ù–µ–º–∞—î")
    data = await state.get_data()
    if data.get("pay_method") == "cash":
        kb = InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text="üí≥ –ö–∞—Ä—Ç–∞", callback_data="pre_card")],[InlineKeyboardButton(text="üíé USDT", callback_data="pre_crypto")]])
        await message.answer(f"–ê–≤–∞–Ω—Å: {data.get('calculated_prepay')} –≥—Ä–Ω. –û–±–µ—Ä—ñ—Ç—å —Å–ø–æ—Å—ñ–± –æ–ø–ª–∞—Ç–∏ –∞–≤–∞–Ω—Å—É:", reply_markup=kb)
        await state.set_state(OrderSteps.waiting_for_prepay_type)
    else: await finalize_order(message, state, "crypto_full")

@dp.callback_query(OrderSteps.waiting_for_prepay_type)
async def prepay_final(callback: types.CallbackQuery, state: FSMContext):
    await finalize_order(callback.message, state, "card" if callback.data == "pre_card" else "crypto")
    await callback.answer()

async def finalize_order(message: types.Message, state: FSMContext, method_key: str):
    data = await state.get_data()
    now = datetime.now().strftime("%d.%m.%Y %H:%M:%S")
    total_uah = data.get('total_price', 0)
    prepay_uah = data.get('calculated_prepay', 200)
    raw_items = data.get('item_name', '')
    
    # --- –ó–ê–ü–ò–° –í –ì–£–ì–õ –¢–ê–ë–õ–ò–¶–Æ ---
    try:
        row = [
            now, 
            data.get('customer_name'), 
            data.get('customer_phone'), 
            raw_items, 
            total_uah, 
            prepay_uah, 
            data.get('operator'), 
            data.get('address'), 
            data.get('comment'),
            method_key
        ]
        sheet.append_row(row)
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Å—É –≤ —Ç–∞–±–ª–∏—Ü—é: {e}")

    # –§–æ—Ä–º—É–≤–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –∞–¥–º—ñ–Ω–∞
    items_list = [i.strip() for i in raw_items.split(',') if i.strip()]
    formatted_items = "\n‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà\n".join(items_list)
    
    admin_msg = (
        f"üì© <b>–ù–û–í–ï –ó–ê–ú–û–í–õ–ï–ù–ù–Ø</b>\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"<b>–¢–æ–≤–∞—Ä–∏ ({len(items_list)} —à—Ç.):</b>\n\n"
        f"{formatted_items}\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üí∞ <b>–°—É–º–∞:</b> {total_uah} –≥—Ä–Ω\n"
        f"üí≥ <b>–ê–≤–∞–Ω—Å:</b> {prepay_uah} –≥—Ä–Ω\n"
        f"üë§ <b>–ö–ª—ñ—î–Ω—Ç:</b> {data.get('customer_name')}\n"
        f"üìû <b>–¢–µ–ª:</b> <code>{data.get('customer_phone')}</code>\n"
        f"üöö <b>–î–æ—Å—Ç–∞–≤–∫–∞:</b> {data.get('operator')}\n"
        f"üìç <b>–ê–¥—Ä–µ—Å–∞:</b> {data.get('address')}"
    )
    
    if "crypto" in method_key:
        rate = await get_usdt_uah_rate()
        amount_uah = prepay_uah if method_key != "crypto_full" else int(total_uah)
        amount_usdt = round(amount_uah / rate, 2)
        invoice = await crypto.create_invoice(amount=amount_usdt, asset='USDT')
        await message.answer(f"‚úÖ –†–∞—Ö—É–Ω–æ–∫ –Ω–∞ {amount_usdt} USDT —Å—Ç–≤–æ—Ä–µ–Ω–æ!", 
                             reply_markup=InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text="üí∞ –°–ø–ª–∞—Ç–∏—Ç–∏", url=invoice.bot_invoice_url)]]))
    else:
        await message.answer("‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏–π–Ω—è—Ç–æ! –ú–µ–Ω–µ–¥–∂–µ—Ä –Ω–∞–¥—ñ—à–ª–µ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏.", reply_markup=get_main_keyboard())
    
    await bot.send_message(ADMIN_ID, admin_msg, parse_mode="HTML")
    await state.clear()

async def main(): await dp.start_polling(bot)
if __name__ == "__main__": asyncio.run(main())
